// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- CORE MODELS ---

model User {
  id String @id @default(uuid())

  email          String @unique
  hashedPassword String
  name           String

  // A user can have many exam attempts
  examAttempts ExamAttempt[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Subject {
  id Int @id @default(autoincrement())

  title       String
  description String?
  sem         SemesterEnum @default(FIRST)
  isEnrolled  Boolean?     @default(true)

  // A subject can contain many tasks, files, exams, and summaries
  tasks Task[]
  files File[]
  exams Exam[] // Relation to the new Exam model
  summaries Summary[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
model File {
  id Int @id @default(autoincrement())

  name      String           @unique // <-- ADD THIS @unique ATTRIBUTE
  fileUrl   String
  size      Int
  type      AcceptedFileType
  embedding Unsupported("vector(1536)")?
  
  contentText String? @db.Text

  subjectId Int?
  subject   Subject? @relation(fields: [subjectId], references: [id])
  exams     Exam[]
  summaries Summary[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --- NEW EXAM-RELATED MODELS ---

// Represents a single exam generated by the AI
model Exam {
  id Int @id @default(autoincrement())

  description    String // The instructions from the form
  requestedItems Int // The number of items requested
  status         ExamStatusEnum @default(GENERATING)
  questionTypes  QuestionTypeEnum[] // The types of questions requested

  // An exam belongs to a subject for organization
  subjectId Int
  subject   Subject @relation(fields: [subjectId], references: [id])

  // An exam is generated from one or more source files (many-to-many)
  sourceFiles File[]

  // An exam has many questions
  questions Question[]

  // An exam can be attempted multiple times
  attempts ExamAttempt[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Represents a single question within an exam
model Question {
  id Int @id @default(autoincrement())

  text          String
  type          QuestionTypeEnum @default(MULTIPLE_CHOICE)
  options       Json // e.g., ["Answer A", "Answer B", "Answer C"]
  correctAnswer String

  // A question belongs to one exam
  examId Int
  exam   Exam @relation(fields: [examId], references: [id], onDelete: Cascade)

  // This question can be answered in multiple different attempts
  userAnswers UserAnswer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ExamAttempt {
  id Int @id @default(autoincrement())

  score       Float? // Nullable until the exam is finished
  status      AttemptStatusEnum @default(IN_PROGRESS)
  startedAt   DateTime          @default(now())
  completedAt DateTime?

  // An attempt is for a specific exam
  examId Int
  exam   Exam @relation(fields: [examId], references: [id], onDelete: Cascade)

  // An attempt is made by a specific user
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // An attempt is composed of many user answers
  answers UserAnswer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UserAnswer {
  id Int @id @default(autoincrement())

  selectedAnswer String
  isCorrect      Boolean // Set after submission for quick scoring/review

  examAttemptId Int
  attempt       ExamAttempt @relation(fields: [examAttemptId], references: [id], onDelete: Cascade)

  questionId Int
  question   Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([examAttemptId, questionId])
}



model Task {
  id          Int            @id @default(autoincrement())
  title       String
  description String
  deadline    DateTime
  status      TaskStatusEnum @default(PLANNED)
  subject     Subject?       @relation(fields: [subjectId], references: [id])
  subjectId   Int?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
}



enum SemesterEnum {
  FIRST
  SECOND
}

enum TaskStatusEnum {
  PLANNED
  ON_PROGRESS
  DONE
}

enum AcceptedFileType {
  PDF
  TEXT
  DOCX
}

enum ExamStatusEnum {
  GENERATING 
  READY      
  FAILED     
}

enum QuestionTypeEnum {
  MULTIPLE_CHOICE
  IDENTIFICATION
  TRUE_FALSE
}

enum AttemptStatusEnum {
  IN_PROGRESS
  COMPLETED
}

// --- SUMMARY-RELATED MODELS ---

model Summary {
  id Int @id @default(autoincrement())

  title       String
  description String // The instructions/focus from the form
  content     String? @db.Text // The generated summary content
  status      SummaryStatusEnum @default(GENERATING)
  template    SummaryTemplateEnum @default(COMPREHENSIVE)

  // A summary belongs to a subject for organization (optional)
  subjectId Int?
  subject   Subject? @relation(fields: [subjectId], references: [id])

  // A summary is generated from one or more source files (many-to-many)
  sourceFiles File[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum SummaryStatusEnum {
  GENERATING
  READY
  FAILED
}

enum SummaryTemplateEnum {
  COMPREHENSIVE
  KEY_POINTS
  CHAPTER_SUMMARY
  CONCEPT_MAP
  CUSTOM
}