generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ClassSchedule {
  id         Int          @id @default(autoincrement())
  userId     String
  subjectId  Int?
  dayOfWeek  DayOfWeek
  startTime  String
  endTime    String
  room       String?
  instructor String?
  type       ScheduleType @default(CLASS)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject Subject? @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([subjectId])
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum ScheduleType {
  CLASS
  REVIEW_SESSION
  EXAM
  OTHER
}

model User {
  id                     String                @id @default(uuid())
  email                  String                @unique
  hashedPassword         String
  name                   String
  profilePicture         String? // URL to profile picture
  bio                    String? // Short bio/description
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  exams                  Exam[]
  examAttempts           ExamAttempt[]
  files                  File[]
  flashcardDecks         FlashcardDeck[]
  flashcardReviews       FlashcardReview[]
  friendshipsAsAddressee Friendship[]          @relation("FriendshipAddressee")
  friendshipsAsRequester Friendship[]          @relation("FriendshipRequester")
  notes                  Note[]
  studyGoals             StudyGoal[]
  studySessions          StudySession[]
  subjects               Subject[]
  summaries              Summary[]
  tasks                  Task[]
  sharedFilesOwned       SharedFile[]          @relation("SharedFileOwner")
  sharedFilesReceived    SharedFile[]          @relation("SharedFileRecipient")
  sharedNotesOwned       SharedNote[]          @relation("SharedNoteOwner")
  sharedNotesReceived    SharedNote[]          @relation("SharedNoteRecipient")
  sharedDecksOwned       SharedFlashcardDeck[] @relation("SharedDeckOwner")
  sharedDecksReceived    SharedFlashcardDeck[] @relation("SharedDeckRecipient")
  chatConversations      ChatConversation[]
  studyStreak            StudyStreak?
  achievements           UserAchievement[]
  xp                     UserXP?
  subjectMastery         SubjectMastery[]
  topicMastery           TopicMastery[]
  documentLinks          DocumentLink[]
  classSchedules         ClassSchedule[]
}

model SubjectMastery {
  id           Int      @id @default(autoincrement())
  userId       String
  subjectId    Int
  masteryScore Float    @default(0) // 0 to 100
  lastActivity DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject      Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([userId, subjectId])
  @@index([userId])
}

model Subject {
  id             Int              @id @default(autoincrement())
  title          String
  description    String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  sem            SemesterEnum     @default(FIRST)
  isEnrolled     Boolean?         @default(true)
  userId         String?
  exams          Exam[]
  files          File[]
  flashcardDecks FlashcardDeck[]
  notes          Note[]
  studyGoals     StudyGoal[]
  studySessions  StudySession[]
  user           User?            @relation(fields: [userId], references: [id])
  summaries      Summary[]
  tasks          Task[]
  masteryEntries SubjectMastery[]
  topics         Topic[]
  classSchedules ClassSchedule[]

  @@index([userId])
}

model TopicMastery {
  id             Int       @id @default(autoincrement())
  userId         String
  topicId        Int
  strength       Float     @default(0) // 0 to 100
  nextReviewAt   DateTime?
  lastReviewedAt DateTime  @default(now())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  topic          Topic     @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@unique([userId, topicId])
  @@index([userId])
  @@index([nextReviewAt])
}

model Topic {
  id        Int            @id @default(autoincrement())
  title     String
  subjectId Int
  parentId  Int?
  order     Int            @default(0)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  subject   Subject        @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  parent    Topic?         @relation("TopicHierarchy", fields: [parentId], references: [id])
  children  Topic[]        @relation("TopicHierarchy")
  questions Question[]
  mastery   TopicMastery[]

  @@index([subjectId])
  @@index([parentId])
}

model File {
  id             Int                    @id @default(autoincrement())
  name           String                 @unique
  fileUrl        String
  size           Int
  type           AcceptedFileType
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  subjectId      Int?
  embedding      Unsupported("vector")?
  contentText    String?
  userId         String?
  subject        Subject?               @relation(fields: [subjectId], references: [id])
  user           User?                  @relation(fields: [userId], references: [id])
  flashcardDecks FlashcardDeck[]
  notes          Note[]
  exams          Exam[]                 @relation("ExamToFile")
  summaries      Summary[]              @relation("FileToSummary")
  sharedWith     SharedFile[]

  @@index([subjectId])
  @@index([userId])
}

model Exam {
  id             Int                @id @default(autoincrement())
  description    String
  requestedItems Int
  status         ExamStatusEnum     @default(GENERATING)
  subjectId      Int
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  questionTypes  QuestionTypeEnum[]
  isPracticeMode Boolean            @default(false)
  isMock         Boolean            @default(false)
  timeLimit      Int?
  userId         String?
  subject        Subject            @relation(fields: [subjectId], references: [id])
  user           User?              @relation(fields: [userId], references: [id])
  attempts       ExamAttempt[]
  questions      Question[]
  sourceFiles    File[]             @relation("ExamToFile")

  @@index([subjectId])
  @@index([userId])
}

model Question {
  id            Int              @id @default(autoincrement())
  text          String
  type          QuestionTypeEnum @default(MULTIPLE_CHOICE)
  options       Json
  correctAnswer String
  examId        Int
  topicId       Int?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  exam          Exam             @relation(fields: [examId], references: [id], onDelete: Cascade)
  topic         Topic?           @relation(fields: [topicId], references: [id])
  userAnswers   UserAnswer[]

  @@index([examId])
  @@index([topicId])
}

model ExamAttempt {
  id          Int               @id @default(autoincrement())
  score       Float?
  status      AttemptStatusEnum @default(IN_PROGRESS)
  startedAt   DateTime          @default(now())
  completedAt DateTime?
  examId      Int
  userId      String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  exam        Exam              @relation(fields: [examId], references: [id], onDelete: Cascade)
  user        User              @relation(fields: [userId], references: [id])
  answers     UserAnswer[]

  @@index([examId])
  @@index([userId])
}

model UserAnswer {
  id             Int         @id @default(autoincrement())
  selectedAnswer String
  isCorrect      Boolean
  feedback       String?
  examAttemptId  Int
  questionId     Int
  attempt        ExamAttempt @relation(fields: [examAttemptId], references: [id], onDelete: Cascade)
  question       Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([examAttemptId, questionId])
  @@index([questionId])
}

model Task {
  id          Int            @id @default(autoincrement())
  title       String
  description String
  status      TaskStatusEnum @default(PLANNED)
  subjectId   Int?
  updatedAt   DateTime       @updatedAt
  deadline    DateTime
  createdAt   DateTime       @default(now())
  userId      String?
  notes       Note[]
  subject     Subject?       @relation(fields: [subjectId], references: [id])
  user        User?          @relation(fields: [userId], references: [id])

  @@index([subjectId])
  @@index([userId])
}

model Summary {
  id          Int                 @id @default(autoincrement())
  title       String
  description String
  content     String?
  status      SummaryStatusEnum   @default(GENERATING)
  template    SummaryTemplateEnum @default(COMPREHENSIVE)
  subjectId   Int?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  userId      String?
  subject     Subject?            @relation(fields: [subjectId], references: [id])
  user        User?               @relation(fields: [userId], references: [id])
  sourceFiles File[]              @relation("FileToSummary")

  @@index([subjectId])
  @@index([userId])
}

model StudySession {
  id             Int               @id @default(autoincrement())
  type           SessionTypeEnum   @default(POMODORO)
  duration       Int
  actualDuration Int?
  status         SessionStatusEnum @default(IN_PROGRESS)
  subjectId      Int?
  userId         String
  startedAt      DateTime          @default(now())
  completedAt    DateTime?
  pausedAt       DateTime?
  pausedDuration Int               @default(0)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  subject        Subject?          @relation(fields: [subjectId], references: [id])
  user           User              @relation(fields: [userId], references: [id])

  @@index([subjectId])
  @@index([userId])
}

model Note {
  id         Int          @id @default(autoincrement())
  title      String
  content    String
  isMarkdown Boolean      @default(false)
  subjectId  Int?
  fileId     Int?
  taskId     Int?
  userId     String
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  file       File?        @relation(fields: [fileId], references: [id])
  subject    Subject?     @relation(fields: [subjectId], references: [id])
  task       Task?        @relation(fields: [taskId], references: [id])
  user       User         @relation(fields: [userId], references: [id])
  tags       NoteTag[]
  sharedWith SharedNote[]

  @@index([subjectId])
  @@index([fileId])
  @@index([taskId])
  @@index([userId])
}

model Tag {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  color       String?
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  notes       NoteTag[]
}

model NoteTag {
  id        Int      @id @default(autoincrement())
  noteId    Int
  tagId     Int
  createdAt DateTime @default(now())
  note      Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([noteId, tagId])
  @@index([tagId])
}

model FlashcardDeck {
  id           Int                   @id @default(autoincrement())
  title        String
  description  String?
  subjectId    Int?
  userId       String
  sourceFileId Int?
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  cards        Flashcard[]
  sourceFile   File?                 @relation(fields: [sourceFileId], references: [id])
  subject      Subject?              @relation(fields: [subjectId], references: [id])
  user         User                  @relation(fields: [userId], references: [id])
  sharedWith   SharedFlashcardDeck[]

  @@index([userId])
  @@index([subjectId])
}

model Flashcard {
  id             Int               @id @default(autoincrement())
  front          String
  back           String
  frontImageUrl  String?
  backImageUrl   String?
  deckId         Int
  easeFactor     Float             @default(2.5)
  interval       Int               @default(0)
  repetitions    Int               @default(0)
  lastReviewedAt DateTime?
  nextReviewAt   DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  deck           FlashcardDeck     @relation(fields: [deckId], references: [id], onDelete: Cascade)
  reviewHistory  FlashcardReview[]

  @@index([deckId])
}

model FlashcardReview {
  id         Int       @id @default(autoincrement())
  cardId     Int
  userId     String
  quality    Int
  timeSpent  Int?
  reviewedAt DateTime  @default(now())
  createdAt  DateTime  @default(now())
  card       Flashcard @relation(fields: [cardId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id])

  @@index([cardId])
  @@index([userId])
}

model StudyGoal {
  id            Int            @id @default(autoincrement())
  periodType    GoalPeriodEnum @default(DAILY)
  targetMinutes Int
  subjectId     Int?
  userId        String
  isActive      Boolean        @default(true)
  startDate     DateTime       @default(now())
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  subject       Subject?       @relation(fields: [subjectId], references: [id])
  user          User           @relation(fields: [userId], references: [id])

  @@index([subjectId])
  @@index([userId])
}

model Friendship {
  id          Int                  @id @default(autoincrement())
  requesterId String
  addresseeId String
  status      FriendshipStatusEnum @default(PENDING)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  addressee   User                 @relation("FriendshipAddressee", fields: [addresseeId], references: [id], onDelete: Cascade)
  requester   User                 @relation("FriendshipRequester", fields: [requesterId], references: [id], onDelete: Cascade)

  @@unique([requesterId, addresseeId])
  @@index([addresseeId])
}

enum SemesterEnum {
  FIRST
  SECOND
}

enum TaskStatusEnum {
  PLANNED
  ON_PROGRESS
  DONE
}

enum AcceptedFileType {
  PDF
  TEXT
  DOCX
}

enum ExamStatusEnum {
  GENERATING
  READY
  FAILED
}

enum QuestionTypeEnum {
  MULTIPLE_CHOICE
  IDENTIFICATION
  TRUE_FALSE
}

enum AttemptStatusEnum {
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

enum SummaryStatusEnum {
  GENERATING
  READY
  FAILED
}

enum SummaryTemplateEnum {
  COMPREHENSIVE
  KEY_POINTS
  CHAPTER_SUMMARY
  CONCEPT_MAP
  CUSTOM
  FILL_IN_THE_BLANKS
}

enum SessionTypeEnum {
  POMODORO
  SHORT_BREAK
  LONG_BREAK
  CUSTOM
}

enum SessionStatusEnum {
  IN_PROGRESS
  PAUSED
  COMPLETED
  CANCELLED
}

enum GoalPeriodEnum {
  DAILY
  WEEKLY
}

enum FriendshipStatusEnum {
  PENDING
  ACCEPTED
  BLOCKED
}

// Sharing Models

model SharedFile {
  id          Int             @id @default(autoincrement())
  fileId      Int
  ownerId     String
  recipientId String
  permission  SharePermission @default(VIEW)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  file        File            @relation(fields: [fileId], references: [id], onDelete: Cascade)
  owner       User            @relation("SharedFileOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  recipient   User            @relation("SharedFileRecipient", fields: [recipientId], references: [id], onDelete: Cascade)

  @@unique([fileId, recipientId])
  @@index([recipientId])
  @@index([ownerId])
}

model SharedNote {
  id          Int             @id @default(autoincrement())
  noteId      Int
  ownerId     String
  recipientId String
  permission  SharePermission @default(VIEW)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  note        Note            @relation(fields: [noteId], references: [id], onDelete: Cascade)
  owner       User            @relation("SharedNoteOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  recipient   User            @relation("SharedNoteRecipient", fields: [recipientId], references: [id], onDelete: Cascade)

  @@unique([noteId, recipientId])
  @@index([recipientId])
  @@index([ownerId])
}

model SharedFlashcardDeck {
  id          Int             @id @default(autoincrement())
  deckId      Int
  ownerId     String
  recipientId String
  permission  SharePermission @default(VIEW)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  deck        FlashcardDeck   @relation(fields: [deckId], references: [id], onDelete: Cascade)
  owner       User            @relation("SharedDeckOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  recipient   User            @relation("SharedDeckRecipient", fields: [recipientId], references: [id], onDelete: Cascade)

  @@unique([deckId, recipientId])
  @@index([recipientId])
  @@index([ownerId])
}

enum SharePermission {
  VIEW
  COPY
}

// AI Chat History
model ChatConversation {
  id        Int           @id @default(autoincrement())
  userId    String
  title     String        @default("New Conversation")
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  messages  ChatMessage[]
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ChatMessage {
  id             Int              @id @default(autoincrement())
  conversationId Int
  role           ChatRoleEnum
  content        String
  createdAt      DateTime         @default(now())
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

enum ChatRoleEnum {
  USER
  ASSISTANT
}

// Study Streaks & Gamification

model StudyStreak {
  id             Int       @id @default(autoincrement())
  userId         String    @unique
  currentStreak  Int       @default(0)
  longestStreak  Int       @default(0)
  lastStudyDate  DateTime?
  totalStudyDays Int       @default(0)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Achievement {
  id               Int                 @id @default(autoincrement())
  code             String              @unique
  name             String
  description      String
  icon             String
  category         AchievementCategory
  requirement      Int // e.g., 7 for "7-day streak", 10 for "complete 10 exams"
  xpReward         Int                 @default(0)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  userAchievements UserAchievement[]
}

model UserAchievement {
  id            Int         @id @default(autoincrement())
  userId        String
  achievementId Int
  unlockedAt    DateTime    @default(now())
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
}

model UserXP {
  id          Int      @id @default(autoincrement())
  userId      String   @unique
  totalXp     Int      @default(0)
  level       Int      @default(1)
  currentRank String   @default("Student")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Cross-document linking for knowledge graph
model DocumentLink {
  id         Int              @id @default(autoincrement())
  sourceType DocumentLinkType
  sourceId   Int
  targetType DocumentLinkType
  targetId   Int
  relevance  Int              @default(50) // 0-100 relevance score
  reason     String? // Why these are linked
  createdAt  DateTime         @default(now())
  userId     String
  user       User             @relation(fields: [userId], references: [id])

  @@unique([sourceType, sourceId, targetType, targetId])
  @@index([userId])
  @@index([sourceType, sourceId])
  @@index([targetType, targetId])
}

enum DocumentLinkType {
  FILE
  NOTE
  TOPIC
  SUMMARY
  FLASHCARD_DECK
}

enum AchievementCategory {
  STREAK
  EXAM
  FLASHCARD
  STUDY_TIME
  SOCIAL
  SPECIAL
}
