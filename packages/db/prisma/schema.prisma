generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String              @id @default(uuid())
  email                  String              @unique
  hashedPassword         String
  name                   String
  profilePicture         String?             // URL to profile picture
  bio                    String?             // Short bio/description
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  exams                  Exam[]
  examAttempts           ExamAttempt[]
  files                  File[]
  flashcardDecks         FlashcardDeck[]
  flashcardReviews       FlashcardReview[]
  friendshipsAsAddressee Friendship[]        @relation("FriendshipAddressee")
  friendshipsAsRequester Friendship[]        @relation("FriendshipRequester")
  notes                  Note[]
  studyGoals             StudyGoal[]
  studySessions          StudySession[]
  subjects               Subject[]
  summaries              Summary[]
  tasks                  Task[]
  sharedFilesOwned       SharedFile[]        @relation("SharedFileOwner")
  sharedFilesReceived    SharedFile[]        @relation("SharedFileRecipient")
  sharedNotesOwned       SharedNote[]        @relation("SharedNoteOwner")
  sharedNotesReceived    SharedNote[]        @relation("SharedNoteRecipient")
  sharedDecksOwned       SharedFlashcardDeck[] @relation("SharedDeckOwner")
  sharedDecksReceived    SharedFlashcardDeck[] @relation("SharedDeckRecipient")
  chatConversations      ChatConversation[]
  studyStreak            StudyStreak?
  achievements           UserAchievement[]
  xp                     UserXP?
}

model Subject {
  id             Int             @id @default(autoincrement())
  title          String
  description    String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  sem            SemesterEnum    @default(FIRST)
  isEnrolled     Boolean?        @default(true)
  userId         String?
  exams          Exam[]
  files          File[]
  flashcardDecks FlashcardDeck[]
  notes          Note[]
  studyGoals     StudyGoal[]
  studySessions  StudySession[]
  user           User?           @relation(fields: [userId], references: [id])
  summaries      Summary[]
  tasks          Task[]
}

model File {
  id             Int                    @id @default(autoincrement())
  name           String                 @unique
  fileUrl        String
  size           Int
  type           AcceptedFileType
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  subjectId      Int?
  embedding      Unsupported("vector")?
  contentText    String?
  userId         String?
  subject        Subject?               @relation(fields: [subjectId], references: [id])
  user           User?                  @relation(fields: [userId], references: [id])
  flashcardDecks FlashcardDeck[]
  notes          Note[]
  exams          Exam[]                 @relation("ExamToFile")
  summaries      Summary[]              @relation("FileToSummary")
  sharedWith     SharedFile[]
}

model Exam {
  id             Int                @id @default(autoincrement())
  description    String
  requestedItems Int
  status         ExamStatusEnum     @default(GENERATING)
  subjectId      Int
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  questionTypes  QuestionTypeEnum[]
  isPracticeMode Boolean            @default(false)
  timeLimit      Int?
  userId         String?
  subject        Subject            @relation(fields: [subjectId], references: [id])
  user           User?              @relation(fields: [userId], references: [id])
  attempts       ExamAttempt[]
  questions      Question[]
  sourceFiles    File[]             @relation("ExamToFile")
}

model Question {
  id            Int              @id @default(autoincrement())
  text          String
  type          QuestionTypeEnum @default(MULTIPLE_CHOICE)
  options       Json
  correctAnswer String
  examId        Int
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  exam          Exam             @relation(fields: [examId], references: [id], onDelete: Cascade)
  userAnswers   UserAnswer[]
}

model ExamAttempt {
  id          Int               @id @default(autoincrement())
  score       Float?
  status      AttemptStatusEnum @default(IN_PROGRESS)
  startedAt   DateTime          @default(now())
  completedAt DateTime?
  examId      Int
  userId      String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  exam        Exam              @relation(fields: [examId], references: [id], onDelete: Cascade)
  user        User              @relation(fields: [userId], references: [id])
  answers     UserAnswer[]
}

model UserAnswer {
  id             Int         @id @default(autoincrement())
  selectedAnswer String
  isCorrect      Boolean
  examAttemptId  Int
  questionId     Int
  attempt        ExamAttempt @relation(fields: [examAttemptId], references: [id], onDelete: Cascade)
  question       Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([examAttemptId, questionId])
}

model Task {
  id          Int            @id @default(autoincrement())
  title       String
  description String
  status      TaskStatusEnum @default(PLANNED)
  subjectId   Int?
  updatedAt   DateTime       @updatedAt
  deadline    DateTime
  createdAt   DateTime       @default(now())
  userId      String?
  notes       Note[]
  subject     Subject?       @relation(fields: [subjectId], references: [id])
  user        User?          @relation(fields: [userId], references: [id])
}

model Summary {
  id          Int                 @id @default(autoincrement())
  title       String
  description String
  content     String?
  status      SummaryStatusEnum   @default(GENERATING)
  template    SummaryTemplateEnum @default(COMPREHENSIVE)
  subjectId   Int?
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  userId      String?
  subject     Subject?            @relation(fields: [subjectId], references: [id])
  user        User?               @relation(fields: [userId], references: [id])
  sourceFiles File[]              @relation("FileToSummary")
}

model StudySession {
  id             Int               @id @default(autoincrement())
  type           SessionTypeEnum   @default(POMODORO)
  duration       Int
  actualDuration Int?
  status         SessionStatusEnum @default(IN_PROGRESS)
  subjectId      Int?
  userId         String
  startedAt      DateTime          @default(now())
  completedAt    DateTime?
  pausedAt       DateTime?
  pausedDuration Int               @default(0)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  subject        Subject?          @relation(fields: [subjectId], references: [id])
  user           User              @relation(fields: [userId], references: [id])
}

model Note {
  id         Int          @id @default(autoincrement())
  title      String
  content    String
  isMarkdown Boolean      @default(false)
  subjectId  Int?
  fileId     Int?
  taskId     Int?
  userId     String
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  file       File?        @relation(fields: [fileId], references: [id])
  subject    Subject?     @relation(fields: [subjectId], references: [id])
  task       Task?        @relation(fields: [taskId], references: [id])
  user       User         @relation(fields: [userId], references: [id])
  tags       NoteTag[]
  sharedWith SharedNote[]
}

model Tag {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  color       String?
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  notes       NoteTag[]
}

model NoteTag {
  id        Int      @id @default(autoincrement())
  noteId    Int
  tagId     Int
  createdAt DateTime @default(now())
  note      Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([noteId, tagId])
}

model FlashcardDeck {
  id           Int                   @id @default(autoincrement())
  title        String
  description  String?
  subjectId    Int?
  userId       String
  sourceFileId Int?
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  cards        Flashcard[]
  sourceFile   File?                 @relation(fields: [sourceFileId], references: [id])
  subject      Subject?              @relation(fields: [subjectId], references: [id])
  user         User                  @relation(fields: [userId], references: [id])
  sharedWith   SharedFlashcardDeck[]
}

model Flashcard {
  id             Int               @id @default(autoincrement())
  front          String
  back           String
  frontImageUrl  String?
  backImageUrl   String?
  deckId         Int
  easeFactor     Float             @default(2.5)
  interval       Int               @default(0)
  repetitions    Int               @default(0)
  lastReviewedAt DateTime?
  nextReviewAt   DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  deck           FlashcardDeck     @relation(fields: [deckId], references: [id], onDelete: Cascade)
  reviewHistory  FlashcardReview[]
}

model FlashcardReview {
  id         Int       @id @default(autoincrement())
  cardId     Int
  userId     String
  quality    Int
  timeSpent  Int?
  reviewedAt DateTime  @default(now())
  createdAt  DateTime  @default(now())
  card       Flashcard @relation(fields: [cardId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id])
}

model StudyGoal {
  id            Int            @id @default(autoincrement())
  periodType    GoalPeriodEnum @default(DAILY)
  targetMinutes Int
  subjectId     Int?
  userId        String
  isActive      Boolean        @default(true)
  startDate     DateTime       @default(now())
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  subject       Subject?       @relation(fields: [subjectId], references: [id])
  user          User           @relation(fields: [userId], references: [id])
}

model Friendship {
  id          Int                  @id @default(autoincrement())
  requesterId String
  addresseeId String
  status      FriendshipStatusEnum @default(PENDING)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  addressee   User                 @relation("FriendshipAddressee", fields: [addresseeId], references: [id], onDelete: Cascade)
  requester   User                 @relation("FriendshipRequester", fields: [requesterId], references: [id], onDelete: Cascade)

  @@unique([requesterId, addresseeId])
}

enum SemesterEnum {
  FIRST
  SECOND
}

enum TaskStatusEnum {
  PLANNED
  ON_PROGRESS
  DONE
}

enum AcceptedFileType {
  PDF
  TEXT
  DOCX
}

enum ExamStatusEnum {
  GENERATING
  READY
  FAILED
}

enum QuestionTypeEnum {
  MULTIPLE_CHOICE
  IDENTIFICATION
  TRUE_FALSE
}

enum AttemptStatusEnum {
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

enum SummaryStatusEnum {
  GENERATING
  READY
  FAILED
}

enum SummaryTemplateEnum {
  COMPREHENSIVE
  KEY_POINTS
  CHAPTER_SUMMARY
  CONCEPT_MAP
  CUSTOM
}

enum SessionTypeEnum {
  POMODORO
  SHORT_BREAK
  LONG_BREAK
  CUSTOM
}

enum SessionStatusEnum {
  IN_PROGRESS
  PAUSED
  COMPLETED
  CANCELLED
}

enum GoalPeriodEnum {
  DAILY
  WEEKLY
}

enum FriendshipStatusEnum {
  PENDING
  ACCEPTED
  BLOCKED
}

// Sharing Models

model SharedFile {
  id          Int              @id @default(autoincrement())
  fileId      Int
  ownerId     String
  recipientId String
  permission  SharePermission  @default(VIEW)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  file        File             @relation(fields: [fileId], references: [id], onDelete: Cascade)
  owner       User             @relation("SharedFileOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  recipient   User             @relation("SharedFileRecipient", fields: [recipientId], references: [id], onDelete: Cascade)

  @@unique([fileId, recipientId])
}

model SharedNote {
  id          Int              @id @default(autoincrement())
  noteId      Int
  ownerId     String
  recipientId String
  permission  SharePermission  @default(VIEW)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  note        Note             @relation(fields: [noteId], references: [id], onDelete: Cascade)
  owner       User             @relation("SharedNoteOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  recipient   User             @relation("SharedNoteRecipient", fields: [recipientId], references: [id], onDelete: Cascade)

  @@unique([noteId, recipientId])
}

model SharedFlashcardDeck {
  id          Int              @id @default(autoincrement())
  deckId      Int
  ownerId     String
  recipientId String
  permission  SharePermission  @default(VIEW)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  deck        FlashcardDeck    @relation(fields: [deckId], references: [id], onDelete: Cascade)
  owner       User             @relation("SharedDeckOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  recipient   User             @relation("SharedDeckRecipient", fields: [recipientId], references: [id], onDelete: Cascade)

  @@unique([deckId, recipientId])
}

enum SharePermission {
  VIEW
  COPY
}

// AI Chat History
model ChatConversation {
  id        Int           @id @default(autoincrement())
  userId    String
  title     String        @default("New Conversation")
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  messages  ChatMessage[]
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ChatMessage {
  id             Int              @id @default(autoincrement())
  conversationId Int
  role           ChatRoleEnum
  content        String
  createdAt      DateTime         @default(now())
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

enum ChatRoleEnum {
  USER
  ASSISTANT
}

// Study Streaks & Gamification

model StudyStreak {
  id              Int       @id @default(autoincrement())
  userId          String    @unique
  currentStreak   Int       @default(0)
  longestStreak   Int       @default(0)
  lastStudyDate   DateTime?
  totalStudyDays  Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Achievement {
  id          Int               @id @default(autoincrement())
  code        String            @unique
  name        String
  description String
  icon        String
  category    AchievementCategory
  requirement Int               // e.g., 7 for "7-day streak", 10 for "complete 10 exams"
  xpReward    Int               @default(0)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  userAchievements UserAchievement[]
}

model UserAchievement {
  id            Int         @id @default(autoincrement())
  userId        String
  achievementId Int
  unlockedAt    DateTime    @default(now())
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@index([userId])
}

model UserXP {
  id          Int      @id @default(autoincrement())
  userId      String   @unique
  totalXp     Int      @default(0)
  level       Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum AchievementCategory {
  STREAK
  EXAM
  FLASHCARD
  STUDY_TIME
  SOCIAL
  SPECIAL
}
